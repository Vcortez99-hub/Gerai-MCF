const Anthropic = require('@anthropic-ai/sdk');
const fs = require('fs-extra');
const path = require('path');

class ClaudeAIService {
  constructor() {
    this.provider = process.env.AI_PROVIDER || 'anthropic';

    if (this.provider === 'anthropic' && process.env.ANTHROPIC_API_KEY) {
      this.anthropic = new Anthropic({
        apiKey: process.env.ANTHROPIC_API_KEY
      });
      this.model = process.env.ANTHROPIC_MODEL || 'claude-3-5-sonnet-20241022';
    } else {
      // Fallback to simple AI if no Claude key
      this.provider = 'simple';
    }
  }

  async generateContent(briefing, config) {
    try {
      let result;
      if (this.provider === 'anthropic') {
        result = await this.generateWithClaude(briefing, config);
      } else {
        result = this.generateSimple(briefing, config);
      }

      return {
        success: true,
        data: result
      };
    } catch (error) {
      console.error('Erro na gera√ß√£o de conte√∫do:', error);
      // Fallback to simple generation on error
      const result = this.generateSimple(briefing, config);
      return {
        success: true,
        data: result
      };
    }
  }

  async generateWithClaude(briefing, config) {
    console.log('ü§ñ Gerando com Claude para briefing:', briefing.substring(0, 100) + '...');

    const prompt = await this.buildPrompt(briefing, config);

    console.log('üìù Prompt length:', prompt.length, 'characters');

    const response = await this.anthropic.messages.create({
      model: this.model,
      max_tokens: 8000, // Aumentado para permitir respostas mais completas
      temperature: 0.3, // Reduzido para mais consist√™ncia
      messages: [
        {
          role: "user",
          content: prompt
        }
      ]
    });

    console.log('üì¶ Claude response received, length:', response.content[0].text.length);

    const content = response.content[0].text;
    return this.parseAIResponse(content, config);
  }

  async buildPrompt(briefing, config) {
    try {
      // Load external prompt if specified
      if (config.promptType) {
        const promptPath = path.join(__dirname, '..', 'prompts', `${config.promptType}.md`);
        if (await fs.pathExists(promptPath)) {
          let promptTemplate = await fs.readFile(promptPath, 'utf-8');

          // Replace template variables
          promptTemplate = promptTemplate.replace(/\{\{company\}\}/g, config.company || 'Cliente');
          promptTemplate = promptTemplate.replace(/\{\{audience\}\}/g, config.audience || 'Executivos');
          promptTemplate = promptTemplate.replace(/\{\{duration\}\}/g, config.duration || '15');
          promptTemplate = promptTemplate.replace(/\{\{slideCount\}\}/g, config.slideCount || '6');
          promptTemplate = promptTemplate.replace(/\{\{tone\}\}/g, config.tone || 'profissional');
          promptTemplate = promptTemplate.replace(/\{\{briefing\}\}/g, briefing);

          return promptTemplate;
        }
      }

      // Fallback to default prompt
      return this.buildDefaultPrompt(briefing, config);
    } catch (error) {
      console.warn('Erro ao carregar prompt externo, usando padr√£o:', error.message);
      return this.buildDefaultPrompt(briefing, config);
    }
  }

  buildDefaultPrompt(briefing, config) {
    const { templateType, company, audience, duration, slideCount, tone } = config;

    return `Voc√™ √© um especialista em cria√ß√£o de apresenta√ß√µes corporativas de alta qualidade, com capacidade de gerar conte√∫do espec√≠fico, detalhado e relevante. Analise o briefing fornecido e crie uma apresenta√ß√£o completa e profissional.

BRIEFING DO CLIENTE:
${briefing}

CONFIGURA√á√ïES DA APRESENTA√á√ÉO:
- Empresa: ${company || 'Cliente'}
- P√∫blico-alvo: ${audience || 'Executivos'}
- Dura√ß√£o: ${duration || '15'} minutos
- N√∫mero de slides: ${slideCount || '6'}
- Tom: ${tone || 'profissional'}
- Tipo: ${templateType || 'comercial'}

INSTRU√á√ïES CR√çTICAS:
1. ANALISE PROFUNDAMENTE o briefing - extraia insights espec√≠ficos, dados relevantes e contexto
2. GERE CONTE√öDO √öNICO baseado no briefing real, n√£o templates gen√©ricos
3. SEJA ESPEC√çFICO - use dados, n√∫meros, exemplos concretos quando poss√≠vel
4. ADAPTE a linguagem para o p√∫blico-alvo e tom especificados
5. CRIE uma narrativa coesa que conecte todos os slides
6. INCLUA detalhes t√©cnicos e comerciais relevantes
7. SUGIRA elementos visuais espec√≠ficos para cada slide

M√ìDULOS OBRIGAT√ìRIOS (todos devem ser preenchidos):
Gere TODOS os m√≥dulos com conte√∫do rico e espec√≠fico:

1. CAPA - T√≠tulo impactante e espec√≠fico do briefing
2. AGENDA - Estrutura clara baseada no conte√∫do
3. PROBLEMA/CONTEXTO - Desafio espec√≠fico identificado no briefing
4. SOLU√á√ÉO - Proposta detalhada e espec√≠fica
5. COMPARATIVO - Antes vs Depois ou an√°lise competitiva
6. CASES - Exemplos pr√°ticos relevantes
7. M√âTRICAS - KPIs e resultados mensur√°veis
8. TIMELINE - Cronograma de implementa√ß√£o
9. CONCLUS√ÉO - Pr√≥ximos passos espec√≠ficos

FORMATO DE RESPOSTA (JSON v√°lido e completo):
{
  "title": "T√≠tulo espec√≠fico baseado no briefing (n√£o gen√©rico)",
  "slideCount": ${slideCount || 9},
  "modules": {
    "capa": {
      "title": "T√≠tulo da apresenta√ß√£o espec√≠fico para o briefing",
      "content": "Subt√≠tulo que resume a proposta principal",
      "subtitle": "Linha de apoio com empresa e data"
    },
    "agenda": {
      "title": "Agenda da Apresenta√ß√£o",
      "content": "Estrutura planejada para atingir os objetivos",
      "bullets": ["T√≥pico espec√≠fico 1", "T√≥pico espec√≠fico 2", "T√≥pico espec√≠fico 3", "Pr√≥ximos passos"]
    },
    "problema": {
      "title": "Desafio/Oportunidade Identificada",
      "content": "An√°lise detalhada do contexto e problema espec√≠fico do briefing",
      "bullets": ["Ponto cr√≠tico 1 baseado no briefing", "Ponto cr√≠tico 2 espec√≠fico", "Impacto nos resultados"],
      "stats": "Estat√≠stica ou dado relevante do setor/problema"
    },
    "solucao": {
      "title": "Nossa Proposta de Solu√ß√£o",
      "content": "Descri√ß√£o detalhada da solu√ß√£o espec√≠fica para o problema identificado",
      "bullets": ["Benef√≠cio espec√≠fico 1", "Benef√≠cio espec√≠fico 2", "Diferencial competitivo", "Valor agregado"]
    },
    "comparativo": {
      "title": "An√°lise Comparativa",
      "content": "Compara√ß√£o entre situa√ß√£o atual e futura ou vs concorr√™ncia",
      "bullets": ["Situa√ß√£o atual: problema espec√≠fico", "Com nossa solu√ß√£o: melhoria espec√≠fica", "Vantagem competitiva clara"]
    },
    "cases": {
      "title": "Cases de Sucesso Relevantes",
      "content": "Exemplos pr√°ticos de implementa√ß√£o similar",
      "bullets": ["Case 1: empresa similar - resultado espec√≠fico", "Case 2: mesmo setor - m√©trica concreta", "Case 3: implementa√ß√£o recente - ROI alcan√ßado"]
    },
    "metricas": {
      "title": "Resultados e Indicadores",
      "content": "KPIs mensur√°veis e espec√≠ficos esperados",
      "metrics": [
        {"label": "M√©trica principal", "value": "Valor espec√≠fico", "description": "Explica√ß√£o do impacto"},
        {"label": "ROI", "value": "Porcentagem realista", "description": "Retorno sobre investimento"},
        {"label": "Efici√™ncia", "value": "Melhoria espec√≠fica", "description": "Ganho operacional"},
        {"label": "Satisfa√ß√£o", "value": "Meta espec√≠fica", "description": "Indicador de qualidade"}
      ]
    },
    "timeline": {
      "title": "Cronograma de Implementa√ß√£o",
      "content": "Planejamento detalhado das etapas",
      "bullets": ["Fase 1: An√°lise e planejamento (prazo espec√≠fico)", "Fase 2: Implementa√ß√£o piloto (prazo espec√≠fico)", "Fase 3: Rollout completo (prazo espec√≠fico)", "Fase 4: Monitoramento e otimiza√ß√£o"]
    },
    "conclusao": {
      "title": "Pr√≥ximos Passos",
      "content": "Resumo dos benef√≠cios e a√ß√µes espec√≠ficas",
      "bullets": ["Aprova√ß√£o da proposta espec√≠fica", "Defini√ß√£o de cronograma detalhado", "In√≠cio da implementa√ß√£o", "Acompanhamento de resultados"]
    }
  },
  "suggestedAssets": {
    "colorPalette": ["#2563eb", "#059669", "#dc2626"],
    "icons": ["analytics", "growth", "solution", "success"],
    "imageSearch": ["business transformation", "digital innovation", "team collaboration"]
  },
  "narrative": {
    "hook": "Frase de abertura espec√≠fica e impactante baseada no briefing",
    "cta": "Call to action espec√≠fico e actionable",
    "keyMessage": "Mensagem principal que conecta problema, solu√ß√£o e resultados"
  }
}

CR√çTICO: Responda APENAS com o JSON v√°lido, sem formata√ß√£o markdown. O JSON deve ser completo com TODOS os m√≥dulos preenchidos com conte√∫do espec√≠fico e relevante.`;
  }

  parseAIResponse(response, config) {
    try {
      console.log('üîç Raw AI Response:', response.substring(0, 500) + '...');

      // Limpeza mais robusta da resposta
      let cleanResponse = response
        .replace(/```json\n?|```\n?/g, '')
        .replace(/^[^{]*/, '') // Remove texto antes do primeiro {
        .replace(/[^}]*$/, '') // Remove texto depois do √∫ltimo }
        .trim();

      // Se n√£o encontrou JSON v√°lido, tentar extrair de outra forma
      if (!cleanResponse.startsWith('{')) {
        const jsonMatch = response.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          cleanResponse = jsonMatch[0];
        }
      }

      console.log('üßπ Cleaned Response:', cleanResponse.substring(0, 200) + '...');

      const parsed = JSON.parse(cleanResponse);

      // Validar se tem a estrutura m√≠nima necess√°ria
      if (!parsed.modules || Object.keys(parsed.modules).length === 0) {
        throw new Error('Resposta AI n√£o cont√©m m√≥dulos v√°lidos');
      }

      const result = {
        ...parsed,
        generatedAt: new Date().toISOString(),
        config,
        provider: this.provider,
        model: this.model
      };

      console.log('‚úÖ AI Response parsed successfully with', Object.keys(result.modules).length, 'modules');
      return result;

    } catch (error) {
      console.error('‚ùå Erro ao parsear resposta do Claude:', error.message);
      console.log('üìÑ Original response:', response);

      // Fallback mais inteligente
      console.log('üîÑ Usando gera√ß√£o fallback melhorada...');
      return this.generateEnhancedFallback(config.aiPrompt || '', config);
    }
  }

  generateEnhancedFallback(briefing, config) {
    console.log('üöÄ Gerando fallback melhorado para:', briefing.substring(0, 100));
    return this.generateSimple(briefing, config);
  }

  generateSimple(briefing, config) {
    console.log('ü§ñ Gerando conte√∫do com IA simples para:', briefing.substring(0, 100));

    const words = briefing.toLowerCase().split(' ');
    const slideCount = parseInt(config.slideCount) || 6;

    // An√°lise inteligente do briefing para gerar t√≠tulo espec√≠fico
    let title = "Apresenta√ß√£o Personalizada";

    // Detecta temas espec√≠ficos no briefing
    if (words.includes('contact center') || words.includes('atendimento')) {
      title = "Revolu√ß√£o no Contact Center: " + (config.company || 'Sua Empresa');
    } else if (words.includes('automa√ß√£o') || words.includes('automatizar')) {
      title = "Transforma√ß√£o Digital atrav√©s da Automa√ß√£o";
    } else if (words.includes('vendas') || words.includes('comercial')) {
      title = "Estrat√©gia Comercial Inovadora";
    } else if (words.includes('treinamento') || words.includes('capacita√ß√£o')) {
      title = "Programa de Capacita√ß√£o Avan√ßada";
    } else if (words.includes('seguran√ßa') || words.includes('security')) {
      title = "Seguran√ßa e Compliance Empresarial";
    } else if (words.includes('marketing') || words.includes('digital')) {
      title = "Estrat√©gia de Marketing Digital";
    } else if (words.includes('inova√ß√£o') || words.includes('transforma√ß√£o')) {
      title = "Inova√ß√£o e Transforma√ß√£o Empresarial";
    } else {
      // Usa as primeiras palavras significativas do briefing para criar um t√≠tulo
      const significantWords = briefing.split(' ').filter(word =>
        word.length > 3 &&
        !['para', 'sobre', 'como', 'quando', 'onde', 'porque', 'esta', 'esse', 'essa'].includes(word.toLowerCase())
      ).slice(0, 3);

      if (significantWords.length > 0) {
        title = significantWords.join(' ') + ' - Estrat√©gia Empresarial';
      }
    }

    console.log('üìù T√≠tulo gerado:', title);

    const allModules = {
      capa: {
        title: title,
        content: `Apresenta√ß√£o para ${config.audience || 'stakeholders'}`,
        subtitle: `${config.company || 'Nossa Empresa'} - ${new Date().getFullYear()}`
      },
      agenda: {
        title: "Agenda da Apresenta√ß√£o",
        content: "Estrutura da apresenta√ß√£o baseada no briefing fornecido",
        bullets: [
          "Contexto atual do neg√≥cio",
          "Desafios identificados",
          "Solu√ß√£o proposta",
          "Benef√≠cios esperados",
          "Plano de implementa√ß√£o"
        ]
      },
      problema: {
        title: "Desafio Identificado",
        content: `Baseado no briefing fornecido: "${briefing.substring(0, 200)}...". Esta an√°lise mostra a necessidade de uma abordagem estrat√©gica para resolver os desafios apresentados.`,
        bullets: [
          `An√°lise espec√≠fica: ${briefing.split(' ').slice(0, 8).join(' ')}`,
          "Impacto direto nos resultados operacionais",
          "Oportunidade de otimiza√ß√£o identificada",
          "Necessidade de solu√ß√£o personalizada"
        ],
        stats: "Melhoria potencial significativa identificada"
      },
      solucao: {
        title: `Nossa Proposta para ${config.company || 'Sua Empresa'}`,
        content: `Solu√ß√£o personalizada desenvolvida especificamente para atender ao briefing: "${briefing.substring(0, 150)}...". Nossa abordagem foca em resultados mensur√°veis e implementa√ß√£o eficiente.`,
        bullets: [
          `Estrat√©gia customizada baseada em: ${briefing.split(' ').slice(0, 6).join(' ')}`,
          "Implementa√ß√£o gradual e monitorada",
          "Tecnologia adequada √†s necessidades espec√≠ficas",
          "Suporte especializado durante todo o processo",
          "ROI mensur√°vel desde o primeiro m√™s"
        ]
      },
      comparativo: {
        title: "An√°lise Comparativa",
        content: "Compara√ß√£o entre situa√ß√£o atual e futura com nossa solu√ß√£o",
        bullets: [
          "Situa√ß√£o Atual: Processos manuais e demorados",
          "Com Nossa Solu√ß√£o: Automatiza√ß√£o e efici√™ncia",
          "Resultado: Ganhos significativos de produtividade"
        ]
      },
      cases: {
        title: "Cases de Sucesso",
        content: "Exemplos pr√°ticos de implementa√ß√£o bem-sucedida em empresas similares",
        bullets: [
          "Case 1: Empresa do mesmo setor - 80% redu√ß√£o de tempo",
          "Case 2: Implementa√ß√£o similar - 300% ROI em 12 meses",
          "Case 3: Cliente recente - 95% satisfa√ß√£o da equipe"
        ]
      },
      metricas: {
        title: "Resultados Esperados",
        content: "Indicadores de sucesso mensur√°veis e tang√≠veis",
        metrics: [
          { label: "Efici√™ncia", value: "+80%", description: "Melhoria nos processos operacionais" },
          { label: "ROI", value: "300%", description: "Retorno sobre investimento em 12 meses" },
          { label: "Satisfa√ß√£o", value: "95%", description: "Aprova√ß√£o dos usu√°rios finais" },
          { label: "Redu√ß√£o de Custos", value: "40%", description: "Economia operacional anual" }
        ]
      },
      timeline: {
        title: "Cronograma de Implementa√ß√£o",
        content: "Planejamento detalhado das etapas de implementa√ß√£o",
        bullets: [
          "Fase 1 (M√™s 1): An√°lise detalhada e planejamento",
          "Fase 2 (M√™s 2-3): Implementa√ß√£o piloto e ajustes",
          "Fase 3 (M√™s 4-6): Rollout completo e treinamento das equipes"
        ]
      },
      conclusao: {
        title: "Pr√≥ximos Passos",
        content: "Resumo dos benef√≠cios e call-to-action para dar continuidade",
        bullets: [
          "Aprova√ß√£o da proposta apresentada",
          "Defini√ß√£o do cronograma de implementa√ß√£o",
          "In√≠cio imediato do projeto de transforma√ß√£o"
        ]
      }
    };

    // Selecionar m√≥dulos baseado na quantidade de slides
    const moduleKeys = Object.keys(allModules);
    const selectedKeys = moduleKeys.slice(0, Math.min(slideCount, moduleKeys.length));
    const selectedModules = {};
    selectedKeys.forEach(key => {
      selectedModules[key] = allModules[key];
    });

    return {
      title,
      slideCount,
      modules: selectedModules,
      suggestedAssets: {
        colorPalette: ["#007bff", "#28a745", "#ffc107"],
        icons: ["growth", "innovation", "success", "efficiency"],
        imageSearch: ["business growth", "team collaboration", "digital transformation"]
      },
      narrative: {
        hook: "Uma oportunidade √∫nica de transforma√ß√£o empresarial",
        cta: "Vamos come√ßar essa jornada de transforma√ß√£o juntos?",
        keyMessage: "Resultados mensur√°veis atrav√©s de solu√ß√µes inovadoras e personalizadas"
      },
      generatedAt: new Date().toISOString(),
      config,
      provider: 'simple-fallback'
    };
  }

  async generateImageSuggestions(context, keywords = []) {
    try {
      if (this.provider === 'anthropic') {
        const prompt = `Com base no contexto "${context}" e palavras-chave [${keywords.join(', ')}], sugira 5 termos de busca para imagens profissionais de apresenta√ß√£o. Responda apenas com os termos separados por v√≠rgula.`;

        const response = await this.anthropic.messages.create({
          model: this.model,
          max_tokens: 200,
          messages: [{ role: "user", content: prompt }]
        });

        const suggestions = response.content[0].text.split(',').map(s => s.trim()).slice(0, 5);

        return {
          primary: suggestions.slice(0, 3),
          alternative: suggestions.slice(3, 5),
          style: 'professional, clean, modern business',
          avoid: 'clipart, cartoon, low-quality, watermarks'
        };
      } else {
        return this.generateSimpleImageSuggestions(context, keywords);
      }
    } catch (error) {
      return this.generateSimpleImageSuggestions(context, keywords);
    }
  }

  generateSimpleImageSuggestions(context, keywords = []) {
    const contextKeywords = {
      'problem': ['challenge', 'issue', 'obstacle', 'difficulty'],
      'solution': ['innovation', 'technology', 'progress', 'breakthrough'],
      'metrics': ['growth', 'chart', 'success', 'achievement'],
      'team': ['collaboration', 'teamwork', 'people', 'meeting'],
      'business': ['corporate', 'office', 'professional', 'enterprise']
    };

    let searchTerms = [...keywords];

    Object.keys(contextKeywords).forEach(key => {
      if (context.toLowerCase().includes(key)) {
        searchTerms.push(...contextKeywords[key]);
      }
    });

    if (searchTerms.length === 0) {
      searchTerms = ['business', 'professional', 'corporate', 'success'];
    }

    return {
      primary: searchTerms.slice(0, 3),
      alternative: searchTerms.slice(3, 6),
      style: 'professional, clean, modern business',
      avoid: 'clipart, cartoon, low-quality, watermarks'
    };
  }

  static async listAvailablePrompts() {
    try {
      const promptsDir = path.join(__dirname, '..', 'prompts');
      await fs.ensureDir(promptsDir);

      const files = await fs.readdir(promptsDir);
      const prompts = [];

      for (const file of files) {
        if (file.endsWith('.md')) {
          const filePath = path.join(promptsDir, file);
          const content = await fs.readFile(filePath, 'utf-8');

          // Extract metadata from markdown
          const titleMatch = content.match(/# Prompt: (.+)/);
          const categoryMatch = content.match(/\*\*Categoria\*\*: (.+)/);
          const typeMatch = content.match(/\*\*Tipo\*\*: (.+)/);
          const audienceMatch = content.match(/\*\*P√∫blico-alvo\*\*: (.+)/);

          const promptId = path.parse(file).name;

          prompts.push({
            id: promptId,
            name: titleMatch ? titleMatch[1] : promptId,
            category: categoryMatch ? categoryMatch[1] : 'Geral',
            type: typeMatch ? typeMatch[1] : 'Apresenta√ß√£o',
            audience: audienceMatch ? audienceMatch[1] : 'Geral',
            filename: file
          });
        }
      }

      return prompts.sort((a, b) => a.name.localeCompare(b.name));
    } catch (error) {
      console.error('Erro ao listar prompts:', error);
      return [];
    }
  }
}

module.exports = ClaudeAIService;